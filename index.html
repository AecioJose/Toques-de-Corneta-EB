<!DOCTYPE html >
<html lang="en">

<head>
    <meta charset="utf-8" />
<title>Web Audio API examples: Basics</title>
<meta name="description" content="Audio basics demo for Web Audio API" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link rel="stylesheet" href="style.css">
<script src="script.js"></script>
</head>

<body>
<input type="file" id="file" accept="audio/*">
<div id="boombox">
<div class="boombox-handle"></div>

<div class="boombox-body">
<section class="master-controls">
<input type="range" id="volume" min="0" max="2" value="1" step="0.01">

<label for="volume">VOL</label>

<input type="range" id="panner" min="-1" max="1" value="0" step="0.001" />

<label for="panner">PAN</label>

</section>
<button onclick="playpause()">PLAY/PAUSE</button>
<canvas id="audioCanvas"></canvas>
</div>
<!-- boombox-body -->
</div>

<script type="text/javascript">
console.clear();

// instigate our audio context
let audioCtx;
const audioControler = new AudioControler()

// load some sound
const audioElement = document.querySelector("audio");
const fileElement = document.querySelector("#file");
const volumeControl = document.querySelector('#volume');
const pannerControl = document.querySelector('#panner');


fileElement.addEventListener("change", (e) => {
audioControler.initialize()
audioControler.setSource(URL.createObjectURL(e.target.files[0]))
})

volumeControl.addEventListener(
"input",
(event) => {
audioControler.setVol(event.target.value)
},
false
);

pannerControl.addEventListener(
"input",
(event) => {
audioControler.setPan(event.target.value)
},
false
);

function playpause() {
if (audioControler.audioElement.paused) {
audioControler.play()
} else {
audioControler.pause()
}
}

const canvas = document.getElementById('audioCanvas');
const canvasCtx = canvas.getContext('2d');
const lineOld = {l: canvas.height, r: canvas.height}

function draw() {
    canvasCtx.fillStyle = 'rgb(200, 200, 200)';
    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    
    const dataL = audioControler.getByteFrequencyDataL()
    const dataR = audioControler.getByteFrequencyDataR()
    
    let L = audioControler.getMedia(dataL)
    let R = audioControler.getMedia(dataR)
    
    let Lh = audioControler.map(R, 0, 255, 0, canvas.height)
    let Rh = audioControler.map(L, 0, 255, 0, canvas.height)
    
    canvasCtx.fillStyle = "#ffffff"
    canvasCtx.fillRect(
        90,
        lineOld.l - 10, 
        30, 
        10)
    canvasCtx.fillStyle = "rgb(49,255,9)"
    canvasCtx.fillRect(
        90,
        canvas.height - Lh, 
        30, 
        canvas.height)
    if (canvas.height - Lh < lineOld.l) {
        lineOld.l = canvas.height - Lh
    }
     
    canvasCtx.fillStyle = "#ffffff"   
    canvasCtx.fillRect(
        30, 
        lineOld.r - 10, 
        30,
        10)
    canvasCtx.fillStyle = "rgb(49,255,9)"
    canvasCtx.fillRect(
        30, 
        canvas.height - Rh, 
        30,
        canvas.height)
    if (canvas.height - Rh < lineOld.r) {
        lineOld.r = canvas.height - Rh
    }
    
    lineOld.l = lineOld.l - 0.01
    lineOld.r = lineOld.r - 0.01
    requestAnimationFrame(draw);
}

draw()
/*
const dataArray = audioControler.getByteFrequencyData();
const bufferLength = dataArray.length
canvasCtx.fillStyle = 'rgb(200, 200, 200)';
canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

const barWidth = (canvas.width / bufferLength) * 2.5;
let x = 0;

for (let i = 0; i < bufferLength; i++) {
let barHeight = dataArray[i];
canvasCtx.fillStyle = 'rgb(' + (barHeight + 100) + ',50,50)';
canvasCtx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);

x += barWidth + 1;
}

// const leftDataArray = audioControler.getByteFrequencyDataL()
// const rightDataArray = audioControler.getByteFrequencyDataL()
// const barWidth = (canvas.width / 2 / leftDataArray.length) * 2.5;
// // Visualização do canal esquerdo
// canvasCtx.fillStyle = 'rgb(0, 0, 255)'; // Azul para o canal esquerdo
// x = 0;
// for (let i = 0; i < leftDataArray.length; i++) {
//     let barHeight = leftDataArray[i];
//     canvasCtx.fillRect(x, 0, barWidth, barHeight);
//     x += barWidth + 1;
// }

// // Visualização do canal direito
// canvasCtx.fillStyle = 'rgb(255, 0, 0)'; // Vermelho para o canal direito
// x = canvas.width / 2;
// for (let i = 0; i < rightDataArray.length; i++) {
//     let barHeight = rightDataArray[i];
//     canvasCtx.fillRect(x, 0, barWidth, barHeight);
//     x += barWidth + 1;
// }
}

draw();
*/
</script>
</body>

</html>